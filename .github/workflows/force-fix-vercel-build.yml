name: Smart Fix Vercel Config

# 在代码推送到 main 分支时触发（也就是同步完成后）
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  inject-config:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      # 核心步骤：使用 jq 进行智能合并
      # 逻辑：读取 vercel.json，保留原有所有字段（buildCommand等），
      # 仅仅强制覆盖或添加 functions 字段
      - name: Inject Limit Configuration with jq
        run: |
          # 如果 vercel.json 不存在，先创建一个空的
          if [ ! -f vercel.json ]; then
            echo '{}' > vercel.json
          fi

          # 使用 jq 将超时限制注入到现有配置中
          # 这里的 .functions = ... 就是只修改这一部分，其他部分保持原样
          jq '.functions = {
            "src/app/api/**/*": { "maxDuration": 60 },
            "src/app/webapi/**/*": { "maxDuration": 60 }
          }' vercel.json > vercel.tmp && mv vercel.tmp vercel.json

          # 打印出来检查一下（在日志里看）
          cat vercel.json

      - name: Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: smart inject vercel timeout limit"
          branch: main
          file_pattern: vercel.json
